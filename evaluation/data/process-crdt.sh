#!/bin/bash
set -euo pipefail

LOGDIR="${1?Please specify directory containing log files}"

# Processes the log files produced by runs of the experiment in CRDT mode
# (USE_LEADER = false), and extracts the numbers we're interested in, in
# a format ready for Gnuplot. The output file contains the following columns:
#
#  1. Interval between generated ops (microseconds)
#  2. Ops/sec generated by the us-west-1 replica
#  3. Minimum    time to apply a local  operation in us-west-1 (microseconds)
#  4. Median     time to apply a local  operation in us-west-1 (microseconds)
#  5. 95th perc. time to apply a local  operation in us-west-1 (microseconds)
#  6. Minimum    time to apply a remote operation in us-west-1 (microseconds)
#  7. Median     time to apply a remote operation in us-west-1 (microseconds)
#  8. 95th perc. time to apply a remote operation in us-west-1 (microseconds)
#  9. Ops/sec generated by the eu-west-1 replica
# 10. Minimum    time to apply a local  operation in eu-west-1 (microseconds)
# 11. Median     time to apply a local  operation in eu-west-1 (microseconds)
# 12. 95th perc. time to apply a local  operation in eu-west-1 (microseconds)
# 13. Minimum    time to apply a remote operation in eu-west-1 (microseconds)
# 14. Median     time to apply a remote operation in eu-west-1 (microseconds)
# 15. 95th perc. time to apply a remote operation in eu-west-1 (microseconds)
# 16. Ops/sec generated by the ap-southeast-1 replica
# 17. Minimum    time to apply a local  operation in ap-southeast-1 (microseconds)
# 18. Median     time to apply a local  operation in ap-southeast-1 (microseconds)
# 19. 95th perc. time to apply a local  operation in ap-southeast-1 (microseconds)
# 20. Minimum    time to apply a remote operation in ap-southeast-1 (microseconds)
# 21. Median     time to apply a remote operation in ap-southeast-1 (microseconds)
# 22. 95th perc. time to apply a remote operation in ap-southeast-1 (microseconds)

rm -f "$LOGDIR/summary.data"

for interval in $(ls "$LOGDIR"/*.log.gz | sed -e 's/.*interval_//' -e 's/_.*//' | uniq | sort -rn); do
    us_times="$(cat "${LOGDIR}/interval_${interval}_us_west_1.log.gz"      | gunzip | awk -f process-crdt.awk | tail -n 2 | head -n 1 | tr '\n' ',')"
    eu_times="$(cat "${LOGDIR}/interval_${interval}_eu_west_1.log.gz"      | gunzip | awk -f process-crdt.awk | tail -n 2 | head -n 1 | tr '\n' ',')"
    ap_times="$(cat "${LOGDIR}/interval_${interval}_ap_southeast_1.log.gz" | gunzip | awk -f process-crdt.awk | tail -n 2 | head -n 1 | tr '\n' ',')"
    echo "${interval},${us_times}${eu_times}${ap_times}" | tr ',' '\t' >> "$LOGDIR/summary.data"
done
